image: node:18

pipelines:
   pull-requests:
    '**': #this runs as default for any branch not elsewhere defined
    - step:
        name: NPM Install
        script:
          - npm install
    - step:
        name: Zup Deploy
        # set -o pipefail
        # This way if the deploy fails, we fail before piping to tee.
        script:
          - set -o pipefail
          - npx @zuplo/cli deploy --apiKey "$ZUPLO_API_KEY" | tee
            ./DEPLOYMENT_STDOUT
        artifacts:
          - DEPLOYMENT_STDOUT
    - step:
        name: Zup Test
        script:
          - npx @zuplo/cli test --endpoint $(cat ./DEPLOYMENT_STDOUT |  sed -E
            's/Deployed to (.*)/\1/')
